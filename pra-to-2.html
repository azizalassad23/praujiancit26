<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ujian Informatika - Pra TO 2</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #6c5ce7;
            --primary-dark: #5849be;
            --secondary: #a29bfe;
            --text-main: #2d3436;
            --white: #ffffff;
            --danger: #d63031;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #a8c0ff 0%, #3f2b96 100%);
            color: var(--text-main);
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: flex-start;
            user-select: none; /* Mencegah copy paste teks soal */
        }

        .container {
            max-width: 850px;
            width: 100%;
            background: var(--white);
            padding: 40px;
            border-radius: 24px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.15);
            margin-top: 20px;
            position: relative;
            overflow: hidden;
        }

        .container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 8px;
            background: linear-gradient(90deg, #6c5ce7, #00b894);
        }

        h1, h2 { text-align: center; color: var(--text-main); font-weight: 600; }
        
        /* LOGIN STYLE */
        #login-section { text-align: center; padding: 20px; }
        .input-group { margin-bottom: 20px; text-align: left; max-width: 400px; margin-left: auto; margin-right: auto; }
        .input-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #636e72; }
        
        input[type="text"] {
            width: 100%;
            padding: 15px;
            border: 2px solid #dfe6e9;
            border-radius: 12px;
            font-size: 1rem;
            font-family: 'Poppins', sans-serif;
            transition: 0.3s;
            box-sizing: border-box;
        }

        input[type="text"]:focus {
            border-color: var(--primary);
            outline: none;
            box-shadow: 0 0 0 4px rgba(108, 92, 231, 0.1);
        }

        /* BUTTONS */
        .btn {
            background: var(--primary);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 12px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(108, 92, 231, 0.3);
            display: inline-block;
        }

        .btn:hover { background: var(--primary-dark); transform: translateY(-2px); }
        .btn-nav-container { display: flex; justify-content: space-between; margin-top: 30px; }
        .btn-submit { background: #d63031; width: 100%; margin-top: 40px; box-shadow: 0 4px 15px rgba(214, 48, 49, 0.3); }

        /* SOAL STYLE */
        #exam-section { display: none; }
        .question-text { font-size: 1.15rem; font-weight: 500; margin-bottom: 25px; line-height: 1.6; white-space: pre-wrap; }

        /* OPTIONS STYLE */
        .options { display: flex; flex-direction: column; gap: 12px; }
        .option-label {
            display: flex; align-items: center; padding: 15px 20px; background: #f5f6fa;
            border-radius: 12px; cursor: pointer; transition: all 0.2s ease;
        }
        .option-label:hover { background: #e6e6e6; }
        .option-label input[type="radio"] { display: none; }
        .circle-indicator {
            width: 20px; height: 20px; border: 2px solid #b2bec3; border-radius: 50%;
            margin-right: 15px; display: flex; align-items: center; justify-content: center; flex-shrink: 0;
        }
        .circle-indicator::after { content: ''; width: 10px; height: 10px; background: white; border-radius: 50%; transform: scale(0); transition: 0.2s; }
        .option-label.selected { background: rgba(108, 92, 231, 0.1); border: 2px solid var(--primary); color: var(--primary-dark); font-weight: 600; }
        .option-label.selected .circle-indicator { background: var(--primary); border-color: var(--primary); }
        .option-label.selected .circle-indicator::after { transform: scale(1); }

        /* NAV GRID */
        .nav-grid {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(45px, 1fr)); gap: 10px;
            margin-top: 40px; padding-top: 30px; border-top: 2px dashed #dfe6e9;
        }
        .nav-btn {
            width: 100%; aspect-ratio: 1; display: flex; align-items: center; justify-content: center;
            background: white; border: 1px solid #dfe6e9; border-radius: 8px; cursor: pointer;
        }
        .nav-btn.active { background: var(--primary); color: white; }
        .nav-btn.answered { background: #00b894; color: white; border-color: #00b894; }

        /* RESULT SECTION */
        #result-section { display: none; text-align: center; padding: 40px 0; }
        .score-circle {
            width: 180px; height: 180px; background: linear-gradient(135deg, #6c5ce7, #a29bfe);
            color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center;
            font-size: 4em; font-weight: 700; margin: 30px auto;
        }

        pre { background: #2d3436; color: #dfe6e9; padding: 15px; border-radius: 8px; overflow-x: auto; font-family: 'Consolas', monospace; font-size: 0.9em; }

        /* --- SISTEM ANTI CURANG STYLES --- */
        
        /* 1. Modal Peringatan (Kuning/Merah Ringan) */
        .warning-modal {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;
        }
        .warning-box {
            background: white; padding: 30px; border-radius: 16px; text-align: center; max-width: 400px; width: 80%;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); animation: popIn 0.3s ease; border-top: 6px solid #f1c40f;
        }
        .warning-icon { font-size: 3rem; margin-bottom: 10px; }

        /* 2. Layar Blokir (Merah Pekat/Hitam - Penjara) */
        .block-screen {
            display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #2d3436; z-index: 9999; flex-direction: column; justify-content: center; align-items: center;
            color: white; text-align: center; padding: 20px;
        }
        .block-icon { font-size: 5rem; margin-bottom: 20px; animation: pulse 1s infinite; }
        .timer-box { 
            font-size: 3rem; font-weight: 700; font-family: 'Consolas', monospace; 
            background: #d63031; padding: 10px 30px; border-radius: 8px; margin: 20px 0;
        }

        @keyframes popIn { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        
    </style>
</head>
<body>

<div id="warning-modal" class="warning-modal">
    <div class="warning-box">
        <div class="warning-icon">⚠️</div>
        <h3>Terdeteksi Keluar Halaman!</h3>
        <p>Anda dilarang membuka tab lain atau aplikasi lain selama ujian.</p>
        <p style="font-weight: bold; color: #d63031;">Pelanggaran: <span id="violation-count">0</span>/5</p>
        <button class="btn" style="background: #2d3436; margin-top: 15px;" onclick="closeWarning()">Saya Mengerti</button>
    </div>
</div>

<div id="block-screen" class="block-screen">
    <div class="block-icon">⛔</div>
    <h1>AKSES DIBLOKIR</h1>
    <p>Anda telah melakukan kecurangan lebih dari 5 kali.</p>
    <p>Sistem mendeteksi aktivitas mencurigakan berulang.</p>
    <p>Silakan tunggu timer berakhir untuk mengulang ujian dari awal.</p>
    
    <div class="timer-box" id="block-timer">00:00</div>
    
    <p style="font-size: 0.9rem; color: #b2bec3;">Jangan refresh, timer akan tetap berjalan.</p>
</div>

<div class="container">
    <div id="login-section">
        <h2 style="color: var(--primary);">Ujian Informatika</h2>
        <p style="color: #636e72;">Pra TO 2 - Jaga Integritas Anda</p>
        <div style="margin-top: 30px;">
            <div class="input-group">
                <label>Nama Lengkap</label>
                <input type="text" id="nama" placeholder="Ketik nama anda..." required>
            </div>
            <div class="input-group">
                <label>Kelas</label>
                <input type="text" id="kelas" placeholder="Contoh: 12 IPA 1" required>
            </div>
        </div>
        <button class="btn" onclick="startExam()">Mulai Mengerjakan</button>
    </div>

    <div id="exam-section">
        <div id="question-container"></div>
        <div class="btn-nav-container">
            <button class="btn" id="prevBtn" onclick="changeQuestion(-1)" style="background: #b2bec3; color: #2d3436;">Kembali</button>
            <button class="btn" id="nextBtn" onclick="changeQuestion(1)">Selanjutnya</button>
        </div>
        <div class="nav-grid" id="nav-grid"></div>
        <button class="btn btn-submit" onclick="finishExam()">Selesai & Kirim Jawaban</button>
    </div>

    <div id="result-section">
        <h2>Hasil Ujian</h2>
        <p id="student-info" style="font-size: 1.2rem; color: #2d3436;"></p>
        <div class="score-circle" id="score-display">0</div>
        <p id="status-upload" style="font-weight: 500; color: #636e72;">Mengirim data ke server...</p>
    </div>
</div>

<script>
    // --- DATABASE SOAL (Sama seperti sebelumnya) ---
    const questions = [
        {id:1, q:"Komponen fisik pada komputer yang dapat disentuh, dilihat, atau dipindahkan disebut...", a:"C", ops:{A:"Software", B:"Brainware", C:"Hardware", D:"Freeware", E:"Malware"}},
        {id:2, q:"Siklus pengolahan data pada sistem komputer yang benar adalah...", a:"B", ops:{A:"Output -> Process -> Input", B:"Input -> Process -> Output", C:"Process -> Input -> Output", D:"Input -> Output -> Process", E:"Output -> Input -> Process"}},
        {id:3, q:"(Ms. Excel) Jika sel A1 berisi nilai 80 dan sel B1 berisi nilai 70, apakah hasil dari rumus berikut:\n=IF(AND(A1>75; B1>75); \"Lulus\"; \"Remedial\")", a:"B", ops:{A:"Lulus", B:"Remedial", C:"TRUE", D:"FALSE", E:"#VALUE!"}},
        {id:4, q:"Fitur pada Microsoft Word yang memungkinkan pengguna membuat surat massal adalah...", a:"B", ops:{A:"Table of Contents", B:"Mail Merge", C:"Track Changes", D:"Cross-reference", E:"Bibliography"}},
        {id:5, q:"Perangkat lunak sistem operasi yang bersifat open source dan memiliki logo pinguin adalah...", a:"C", ops:{A:"Windows", B:"MacOS", C:"Linux", D:"Android", E:"iOS"}},
        {id:6, q:"Aplikasi Ms. Office yang paling tepat untuk presentasi dengan animasi adalah...", a:"D", ops:{A:"Ms. Access", B:"Ms. Word", C:"Ms. Excel", D:"Ms. PowerPoint", E:"Ms. Publisher"}},
        {id:7, q:"Kepanjangan dari LAN adalah...", a:"A", ops:{A:"Local Area Network", B:"Large Area Network", C:"Local Access Network", D:"Long Area Network", E:"Limited Access Network"}},
        {id:8, q:"Topologi jaringan di mana setiap komputer terhubung ke satu perangkat pusat disebut...", a:"C", ops:{A:"Bus", B:"Ring", C:"Star", D:"Mesh", E:"Tree"}},
        {id:9, q:"Kabel jaringan yang paling umum digunakan untuk instalasi LAN dalam gedung adalah...", a:"C", ops:{A:"Coaxial", B:"Fiber Optic", C:"UTP", D:"STP", E:"HDMI"}},
        {id:10, q:"Subnet mask default Kelas C adalah 255.255.255.0. Dalam notasi CIDR ditulis...", a:"C", ops:{A:"/8", B:"/16", C:"/24", D:"/32", E:"/12"}},
        {id:11, q:"Perangkat yang menghubungkan dua jaringan berbeda segmen/protokol adalah...", a:"D", ops:{A:"Hub", B:"Switch", C:"Bridge", D:"Router", E:"Repeater"}},
        {id:12, q:"Mengapa kabel Cross-Over diperlukan untuk menghubungkan Switch ke Switch (non Auto-MDIX)?", a:"B", ops:{A:"Kecepatan ganda", B:"Pin TX (kirim) harus bertemu Pin RX (terima)", C:"Agar tidak korsleting", D:"Protokol berbeda", E:"Mencegah virus"}},
        {id:13, q:"Pada Packet Tracer, kabel untuk menghubungkan PC ke PC secara langsung adalah...", a:"C", ops:{A:"Console Cable", B:"Straight-Through", C:"Cross-Over", D:"Fiber Cable", E:"Phone Cable"}},
        {id:14, q:"Ekstensi file standar proyek Cisco Packet Tracer adalah...", a:"B", ops:{A:".docx", B:".pkt", C:".html", D:".pptx", E:".cpp"}},
        {id:15, q:"Ikon 'Petir' oranye pada menu Connections Packet Tracer berfungsi untuk...", a:"B", ops:{A:"Menghapus kabel", B:"Memilih jenis kabel otomatis", C:"Mengirim PDU", D:"Reset perangkat", E:"Konek internet"}},
        {id:16, q:"Menu untuk setting IP Address statis pada PC di Packet Tracer adalah...", a:"C", ops:{A:"Command Prompt", B:"Web Browser", C:"IP Configuration", D:"Terminal", E:"VPN"}},
        {id:17, q:"Mode untuk melihat proses pengiriman paket step-by-step di Packet Tracer adalah...", a:"B", ops:{A:"Realtime Mode", B:"Simulation Mode", C:"Physical Mode", D:"Logical Mode", E:"CLI Mode"}},
        {id:18, q:"Ikon untuk mengirim 'Simple PDU' (tes ping sederhana) berbentuk...", a:"A", ops:{A:"Amplop tertutup (+)", B:"Kaca pembesar", C:"Tanda silang", D:"Printer", E:"Folder"}},
        {id:19, q:"Simbol flowchart untuk pengambilan keputusan (Decision) berbentuk...", a:"C", ops:{A:"Persegi Panjang", B:"Lingkaran", C:"Belah Ketupat", D:"Jajar Genjang", E:"Oval"}},
        {id:20, q:"Perintah output teks ke layar dalam C++ adalah...", a:"B", ops:{A:"cin >>", B:"cout <<", C:"scanf()", D:"print()", E:"input()"}},
        {id:21, q:"Tipe data untuk bilangan pecahan (desimal) adalah...", a:"D", ops:{A:"int", B:"char", C:"string", D:"float", E:"bool"}},
        {id:22, q:"Output kode berikut:\nint x = 10; while (x > 0) { cout << x << \" \"; x = x - 3; }", a:"B", ops:{A:"10 9 8 7 6 5 4 3 2 1", B:"10 7 4 1", C:"10 7 4 1 -2", D:"7 4 1", E:"Error"}},
        {id:23, q:"Operator logika 'ATAU' dalam C++ adalah...", a:"B", ops:{A:"&&", B:"||", C:"!", D:"!=", E:"=="}},
        {id:24, q:"Fungsi return 0; pada main() berarti...", a:"C", ops:{A:"Ulang program", B:"Stop paksa", C:"Program sukses", D:"Cetak 0", E:"Hapus memori"}},
        {id:25, q:"Perintah SQL membuat database baru...", a:"B", ops:{A:"CREATE NEW DATABASE s;", B:"CREATE DATABASE s;", C:"MAKE DATABASE s;", D:"NEW DATABASE s;", E:"ADD DATABASE s;"}},
        {id:26, q:"SELECT nama FROM siswa WHERE (nilai_mtk > 80 OR ekskul = 'Robotik') AND kelas = '12';\nMenampilkan siswa yang...", a:"C", ops:{A:"Nilai MTK > 80", B:"Anggota Robotik", C:"Kelas 12 DAN (Nilai > 80 ATAU Robotik)", D:"Kelas 12 DAN Nilai > 80 DAN Robotik", E:"Semua kelas 12"}},
        {id:27, q:"Jenis JOIN yang hanya menampilkan data jika ada kecocokan di kedua tabel...", a:"C", ops:{A:"LEFT JOIN", B:"RIGHT JOIN", C:"INNER JOIN", D:"FULL JOIN", E:"CROSS JOIN"}},
        {id:28, q:"Kueri menghapus tabel guru...", a:"C", ops:{A:"DELETE TABLE", B:"REMOVE TABLE", C:"DROP TABLE", D:"ERASE TABLE", E:"CLEAR TABLE"}},
        {id:29, q:"Constraint agar kolom tidak boleh duplikat dan tidak boleh kosong...", a:"C", ops:{A:"UNIQUE", B:"NOT NULL", C:"PRIMARY KEY", D:"FOREIGN KEY", E:"DEFAULT"}},
        {id:30, q:"Apa yang terjadi jika menghapus data Parent Table yang sedang dipakai di Child Table sebagai Foreign Key?", a:"C", ops:{A:"Terhapus otomatis", B:"Reset database", C:"Gagal (Error Integrity)", D:"Data Parent hilang, Child tetap", E:"Berubah jadi NULL"}},
        {id:31, q:"Perintah menambah data baru ke tabel...", a:"B", ops:{A:"ADD INTO", B:"INSERT INTO", C:"UPDATE", D:"PUSHDOWN", E:"CREATE DATA"}},
        {id:32, q:"Otak dari sistem embedded (Arduino) disebut...", a:"C", ops:{A:"Resistor", B:"Kapasitor", C:"Mikrokontroler", D:"Sensor", E:"Aktuator"}},
        {id:33, q:"Fungsi resistor Pull-Up pada tombol input Arduino adalah...", a:"B", ops:{A:"Cegah arus pendek", B:"Mencegah floating (sinyal mengambang)", C:"Ubah ke analog", D:"Tambah tegangan", E:"Hemat baterai"}},
        {id:34, q:"Pin Arduino untuk membaca nilai potensiometer diawali huruf...", a:"B", ops:{A:"D", B:"A", C:"TX", D:"RX", E:"GND"}},
        {id:35, q:"Fungsi void setup() dieksekusi...", a:"A", ops:{A:"Satu kali saat start", B:"Berulang-ulang", C:"Dua kali", D:"Tergantung sensor", E:"Saat tombol ditekan"}},
        {id:36, q:"Perintah untuk memanipulasi lebar pulsa (PWM/Redup-Terang LED) di Arduino...", a:"B", ops:{A:"digitalRead()", B:"analogWrite()", C:"pulseIn()", D:"tone()", E:"shiftOut()"}},
        {id:37, q:"Keunggulan NodeMCU ESP8266 untuk IoT adalah...", a:"B", ops:{A:"Layar sentuh", B:"Modul Wi-Fi terintegrasi", C:"Ukuran besar", D:"Tanpa listrik", E:"Bahasa Assembly"}},
        {id:38, q:"Struktur dasar HTML diawali dan diakhiri tag...", a:"C", ops:{A:"&lt;body&gt;", B:"&lt;head&gt;", C:"&lt;html&gt;", D:"&lt;title&gt;", E:"&lt;start&gt;"}},
        {id:39, q:"Tag untuk membuat bullet points (tidak berurutan)...", a:"B", ops:{A:"&lt;ol&gt;", B:"&lt;ul&gt;", C:"&lt;li&gt;", D:"&lt;dl&gt;", E:"&lt;list&gt;"}},
        {id:40, q:"Atribut wajib pada tag img untuk lokasi file...", a:"C", ops:{A:"href", B:"link", C:"src", D:"alt", E:"path"}},
        {id:41, q:"CSS: #teks { color: blue; } vs .teks { color: red; }. Warna elemen id='teks' class='teks' adalah...", a:"B", ops:{A:"Merah", B:"Biru (ID lebih prioritas)", C:"Hitam", D:"Ungu", E:"Merah (terakhir)"}},
        {id:42, q:"Properti CSS untuk warna latar belakang...", a:"C", ops:{A:"color", B:"font-color", C:"background-color", D:"bgcolor", E:"back-color"}},
        {id:43, q:"Tag untuk membuat hyperlink...", a:"A", ops:{A:"&lt;a href&gt;", B:"&lt;link src&gt;", C:"&lt;href target&gt;", D:"&lt;hyperlink&gt;", E:"&lt;connect&gt;"}},
        {id:44, q:"Tag &lt;tr&gt; berfungsi membuat...", a:"D", ops:{A:"Kolom", B:"Judul", C:"Sel", D:"Baris tabel", E:"Garis"}},
        {id:45, q:"Kepanjangan CSS...", a:"C", ops:{A:"Computer Style", B:"Creative Style", C:"Cascading Style Sheets", D:"Colorful Style", E:"Code Style"}},
        {id:46, q:"Tag untuk menebalkan huruf...", a:"C", ops:{A:"&lt;i&gt;", B:"&lt;u&gt;", C:"&lt;b&gt;", D:"&lt;p&gt;", E:"&lt;br&gt;"}},
        {id:47, q:"Simbol selector ID di CSS...", a:"B", ops:{A:".", B:"#", C:"@", D:"$", E:"*"}},
        {id:48, q:"Mengapa method='POST' lebih aman untuk form login dibanding 'GET'?", a:"C", ops:{A:"Lebih cepat", B:"GET tidak bisa teks", C:"Data tersembunyi (tidak di URL)", D:"GET untuk gambar", E:"POST tanpa internet"}},
        {id:49, q:"Komentar HTML diawali diakhiri dengan...", a:"C", ops:{A:"//", B:"/* */", C:"&lt;!-- --&gt;", D:"&lt;# #&gt;", E:"{{ }}"}},
        {id:50, q:"Menyisipkan CSS eksternal menggunakan tag...", a:"D", ops:{A:"&lt;style&gt;", B:"&lt;css&gt;", C:"&lt;script&gt;", D:"&lt;link&gt;", E:"&lt;import&gt;"}}
    ];

    // --- CONFIG ---
    const scriptURL = 'https://script.google.com/macros/s/AKfycbxpXezUD81HcQpdNpZxbOuSaY9Pi9eZidgbP-eEpA0ItXjp2xdYdQhZfl6feBZS5j78fA/exec'; 
    const PENALTY_DURATION_MINUTES = 10; // DURASI BLOKIR DALAM MENIT

    // --- VARIABLES ---
    let currentIdx = 0;
    let answers = {};
    let userName = "";
    let userClass = "";
    let isExamStarted = false;

    // --- LOGIKA ANTI CURANG ---
    document.addEventListener("DOMContentLoaded", () => {
        checkBlockStatus();
    });

    document.addEventListener("visibilitychange", () => {
        if (isExamStarted && document.visibilityState === 'hidden') {
            recordViolation();
        }
    });

    function recordViolation() {
        let violations = parseInt(localStorage.getItem('cheatViolations') || "0");
        violations++;
        localStorage.setItem('cheatViolations', violations);

        if (violations > 5) {
            activateBlock();
        } else {
            showWarning(violations);
        }
    }

    function showWarning(count) {
        const modal = document.getElementById('warning-modal');
        document.getElementById('violation-count').innerText = count;
        modal.style.display = 'flex';
    }

    function closeWarning() {
        document.getElementById('warning-modal').style.display = 'none';
    }

    function activateBlock() {
        // Set waktu blokir (sekarang + durasi menit)
        const endTime = new Date().getTime() + (PENALTY_DURATION_MINUTES * 60000);
        localStorage.setItem('blockUntil', endTime);
        showBlockScreen(endTime);
    }

    function checkBlockStatus() {
        const blockUntil = localStorage.getItem('blockUntil');
        
        if (blockUntil) {
            const now = new Date().getTime();
            if (now < blockUntil) {
                // Masih diblokir
                showBlockScreen(parseInt(blockUntil));
            } else {
                // Waktu hukuman habis, reset sistem
                localStorage.removeItem('blockUntil');
                localStorage.removeItem('cheatViolations');
                
                // Pastikan jawaban kosong karena ini refresh
                answers = {}; 
                // Biarkan user login ulang
            }
        }
    }

    function showBlockScreen(endTime) {
        const screen = document.getElementById('block-screen');
        const timerDisplay = document.getElementById('block-timer');
        screen.style.display = 'flex';
        document.body.style.overflow = 'hidden'; // Matikan scroll

        // Update timer setiap detik
        const interval = setInterval(() => {
            const now = new Date().getTime();
            const distance = endTime - now;

            if (distance < 0) {
                clearInterval(interval);
                alert("Waktu hukuman selesai. Halaman akan dimuat ulang.");
                localStorage.removeItem('blockUntil');
                localStorage.removeItem('cheatViolations');
                window.location.reload();
                return;
            }

            const minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((distance % (1000 * 60)) / 1000);

            timerDisplay.innerText = 
                (minutes < 10 ? "0" + minutes : minutes) + ":" + 
                (seconds < 10 ? "0" + seconds : seconds);
        }, 1000);
    }

    // --- FUNGSI UJIAN ---
    function startExam() {
        userName = document.getElementById('nama').value;
        userClass = document.getElementById('kelas').value;

        if(!userName || !userClass) {
            alert("Mohon isi Nama dan Kelas terlebih dahulu!");
            return;
        }

        // Aktifkan mode ujian
        isExamStarted = true;

        document.getElementById('login-section').style.display = 'none';
        document.getElementById('exam-section').style.display = 'block';
        
        renderNav();
        loadQuestion(0);
    }

    function loadQuestion(index) {
        currentIdx = index;
        const q = questions[index];
        const container = document.getElementById('question-container');
        
        const savedAns = answers[q.id] || "";

        let optionsHTML = "";
        ['A', 'B', 'C', 'D', 'E'].forEach(opt => {
            const isSelected = savedAns === opt ? "selected" : "";
            optionsHTML += `
                <label class="option-label ${isSelected}" onclick="selectOption('${opt}')">
                    <div class="circle-indicator"></div>
                    <input type="radio" name="ans" value="${opt}">
                    <span>${q.ops[opt]}</span>
                </label>
            `;
        });

        let qText = q.q;
        if(qText.includes("code") || qText.includes("cpp") || qText.includes("sql") || qText.includes("IF(")) {
             qText = `<pre>${qText}</pre>`;
        } else {
             qText = qText.replace(/\n/g, '<br>');
        }

        container.innerHTML = `
            <div class="question-box">
                <div style="margin-bottom:10px; color:#636e72;">Soal No. ${q.id}</div>
                <div class="question-text">${qText}</div>
                <div class="options">${optionsHTML}</div>
            </div>
        `;

        document.getElementById('prevBtn').disabled = index === 0;
        document.getElementById('nextBtn').innerText = index === questions.length - 1 ? "Selesai" : "Selanjutnya";
        updateNavGrid();
    }

    function selectOption(opt) {
        answers[questions[currentIdx].id] = opt;
        
        const labels = document.querySelectorAll('.option-label');
        labels.forEach(lbl => {
            lbl.classList.remove('selected');
            if(lbl.querySelector(`input[value="${opt}"]`)) {
                lbl.classList.add('selected');
            }
        });
        updateNavGrid();
    }

    function changeQuestion(dir) {
        const newIdx = currentIdx + dir;
        if(newIdx >= 0 && newIdx < questions.length) {
            loadQuestion(newIdx);
        } else if (newIdx === questions.length) {
            finishExam();
        }
    }

    function renderNav() {
        const grid = document.getElementById('nav-grid');
        grid.innerHTML = "";
        questions.forEach((q, idx) => {
            const btn = document.createElement('div');
            btn.className = 'nav-btn';
            btn.innerText = q.id;
            btn.id = `nav-${q.id}`;
            btn.onclick = () => loadQuestion(idx);
            grid.appendChild(btn);
        });
    }

    function updateNavGrid() {
        questions.forEach((q, idx) => {
            const btn = document.getElementById(`nav-${q.id}`);
            if(idx === currentIdx) {
                btn.classList.add('active');
            } else {
                btn.classList.remove('active');
            }
            if(answers[q.id]) btn.classList.add('answered');
        });
    }

    function finishExam() {
        const answeredCount = Object.keys(answers).length;
        if(answeredCount < questions.length) {
            if(!confirm(`Anda baru menjawab ${answeredCount} dari ${questions.length} soal. Yakin ingin selesai?`)) return;
        } else {
            if(!confirm("Apakah Anda yakin ingin mengumpulkan jawaban?")) return;
        }
        
        // Matikan deteksi curang saat submit agar tidak terhitung 'leave'
        isExamStarted = false; 
        calculateAndSubmit();
    }

    function calculateAndSubmit() {
        document.getElementById('exam-section').style.display = 'none';
        document.getElementById('result-section').style.display = 'block';

        let correctCount = 0;
        questions.forEach(q => {
            if(answers[q.id] === q.a) correctCount++;
        });

        const finalScore = correctCount * 2;
        document.getElementById('student-info').innerText = `${userName} - ${userClass}`;
        document.getElementById('score-display').innerText = finalScore;

        const formData = new FormData();
        formData.append('Nama', userName);
        formData.append('Kelas', userClass);
        formData.append('Nilai', finalScore);

        fetch(scriptURL, { method: 'POST', body: formData })
            .then(response => {
                document.getElementById('status-upload').innerText = "✅ Nilai berhasil disimpan!";
                document.getElementById('status-upload').style.color = "#00b894";
                
                // Opsional: Hapus jejak kecurangan jika sudah berhasil submit
                localStorage.removeItem('cheatViolations');
            })
            .catch(error => {
                document.getElementById('status-upload').innerText = "⚠️ Gagal koneksi ke server. Screenshot nilai ini.";
                document.getElementById('status-upload').style.color = "#d63031";
            });
    }
</script>

</body>
</html>
